<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MofuChat - 24時間で消えるかわいいチャット</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800;900&family=Yomogi&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="bg-sparkle"></div>
    <header class="topbar">
      <div class="logo">
        <span class="logo-badge">MC</span>
        <div class="logo-text">
          <h1>MofuChat</h1>
          <p>やさしい 24時間だけの小さなチャット</p>
        </div>
      </div>
      <div class="top-actions">
        <button class="pill" id="newRoomButton">新しいルーム</button>
      </div>
    </header>

    <main class="layout">
      <aside class="panel rooms">
        <div class="panel-header">
          <h2>ルーム</h2>
          <span class="badge" id="roomCount">0</span>
        </div>
        <div class="room-list" id="roomList"></div>
        <div class="panel-footer">
          <div class="tip">
            <span class="tip-title">24時間ルール</span>
            <p>チャットは24時間で消えます。やさしく話そう。</p>
          </div>
        </div>
      </aside>

      <section class="panel chat">
        <div class="panel-header">
          <div>
            <h2 id="roomTitle">Loading...</h2>
            <p class="subtitle" id="roomSubtitle">ローカルサーバーへ接続中</p>
          </div>
        </div>

        <div class="chat-body" id="chatBody"></div>

        <div class="composer">
          <div class="composer-row">
            <input id="composerInput" type="text" placeholder="やさしい言葉をひとこと…" />
            <button class="pill send" id="sendButton">送信</button>
          </div>
        </div>
      </section>
    </main>
    <script>
      const state = { rooms: [], activeRoomId: null };
      const roomPasswords = new Map();
      const nicknameKey = "mofu_nickname";
      let nickname = localStorage.getItem(nicknameKey);

      const roomListEl = document.getElementById("roomList");
      const roomCountEl = document.getElementById("roomCount");
      const roomTitleEl = document.getElementById("roomTitle");
      const roomSubtitleEl = document.getElementById("roomSubtitle");
      const chatBodyEl = document.getElementById("chatBody");
      const composerInput = document.getElementById("composerInput");
      const sendButton = document.getElementById("sendButton");
      const newRoomButton = document.getElementById("newRoomButton");

      const fmtTime = (ms) => {
        const date = new Date(ms);
        const h = String(date.getHours()).padStart(2, "0");
        const m = String(date.getMinutes()).padStart(2, "0");
        return `${h}:${m}`;
      };

      const fmtRemaining = (ms) => {
        if (!ms) return "24時間で自動消去";
        const diff = Math.max(0, ms - Date.now());
        const hours = Math.floor(diff / 3600000);
        const mins = Math.floor((diff % 3600000) / 60000);
        return `自動消去まで ${hours}時間 ${mins}分`;
      };

      function ensureNickname() {
        if (nickname) return;
        const input = window.prompt("ニックネームを登録してください");
        nickname = String(input || "").trim().slice(0, 12);
        if (!nickname) {
          nickname = `ねこ${Math.floor(Math.random() * 900 + 100)}`;
        }
        localStorage.setItem(nicknameKey, nickname);
      }

      function getPasswordForRoom(roomId) {
        return roomPasswords.get(roomId) || "";
      }

      function promptPassword(room) {
        const pw = window.prompt(`「${room.name}」のパスワードを入力`);
        if (!pw) return false;
        roomPasswords.set(room.id, pw);
        return true;
      }

      async function fetchRooms() {
        const res = await fetch("/api/rooms");
        const data = await res.json();
        state.rooms = data.rooms;
        roomCountEl.textContent = data.rooms.length;
        if (!state.activeRoomId && data.rooms.length) {
          state.activeRoomId = data.rooms[0].id;
        }
        if (state.activeRoomId && !data.rooms.find((room) => room.id === state.activeRoomId)) {
          state.activeRoomId = data.rooms[0]?.id || null;
        }
        renderRooms();
        await loadMessages();
      }

      function renderRooms() {
        roomListEl.innerHTML = "";
        state.rooms.forEach((room) => {
          const btn = document.createElement("button");
          btn.className = `room ${room.id === state.activeRoomId ? "active" : ""}`;
          const lockNote = room.hasPassword ? " ・鍵あり" : "";
          btn.innerHTML = `
            <span class="dot"></span>
            <div>
              <h3>${room.name}</h3>
              <p>アクティブ ${room.activeMessages} ・消えるまで ${room.nextExpiresIn}${lockNote}</p>
            </div>
          `;
          btn.addEventListener("click", async () => {
            if (room.hasPassword && !getPasswordForRoom(room.id)) {
              const ok = promptPassword(room);
              if (!ok) return;
            }
            state.activeRoomId = room.id;
            renderRooms();
            await loadMessages();
            // 選択した部屋までスクロール
            setTimeout(() => {
              const activeBtn = roomListEl.querySelector('.room.active');
              if (activeBtn) {
                activeBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
              }
            }, 100);
          });
          roomListEl.appendChild(btn);
        });
      }

      async function loadMessages() {
        if (!state.activeRoomId) return;
        const password = getPasswordForRoom(state.activeRoomId);
        const res = await fetch(`/api/rooms/${state.activeRoomId}/messages`, {
          headers: password ? { "x-room-password": password } : {},
        });
        if (res.status === 403) {
          const room = state.rooms.find((r) => r.id === state.activeRoomId);
          if (room?.hasPassword && promptPassword(room)) {
            return loadMessages();
          }
        }
        const data = await res.json();
        const activeRoom = state.rooms.find((r) => r.id === state.activeRoomId);
        roomTitleEl.textContent = activeRoom?.name || "Room";
        roomSubtitleEl.textContent = fmtRemaining(activeRoom?.nextExpireAt);
        chatBodyEl.innerHTML = "";
        data.messages.forEach((msg) => {
          const wrapper = document.createElement("div");
          const isMe = msg.author === nickname;
          wrapper.className = `message ${isMe ? "me" : "other"}`;
          wrapper.innerHTML = `
            ${isMe ? "" : `
              <div class="author-section">
                <span class="author-name">${msg.author}</span>
                <div class="avatar">?</div>
              </div>
            `}
            <div class="bubble">
              <p>${msg.body}</p>
              <span class="meta">${fmtTime(msg.createdAt)} ・消える時刻 ${fmtTime(msg.expiresAt)}</span>
            </div>
            ${isMe ? `
              <div class="author-section">
                <span class="author-name">${msg.author}</span>
                <div class="avatar">ME</div>
              </div>
            ` : ""}
          `;
          chatBodyEl.appendChild(wrapper);
        });
      }

      async function sendMessage() {
        const body = composerInput.value.trim();
        if (!body || !state.activeRoomId) return;
        const password = getPasswordForRoom(state.activeRoomId);
        await fetch(`/api/rooms/${state.activeRoomId}/messages`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...(password ? { "x-room-password": password } : {}),
          },
          body: JSON.stringify({ author: nickname, body }),
        });
        composerInput.value = "";
        await loadMessages();
      }

      sendButton.addEventListener("click", sendMessage);
      composerInput.addEventListener("keydown", (event) => {
        if (event.key === "Enter") sendMessage();
      });
      newRoomButton.addEventListener("click", async () => {
        const name = window.prompt("ルーム名は？");
        if (!name) return;
        const password = window.prompt("パスワード（任意・空欄OK）") || "";
        await fetch("/api/rooms", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, password }),
        });
        await fetchRooms();
        // 作成した部屋までスクロール
        setTimeout(() => {
          const activeBtn = roomListEl.querySelector('.room.active');
          if (activeBtn) {
            activeBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }
        }, 100);
      });

      ensureNickname();
      fetchRooms();
      setInterval(fetchRooms, 15000);
    </script>
  </body>
</html>
