<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MofuChat - 24時間で消えるかわいいチャット</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800;900&family=Yomogi&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="bg-sparkle"></div>
    <header class="topbar">
      <div class="logo">
        <span class="logo-badge">MC</span>
        <div class="logo-text">
          <h1>MofuChat</h1>
          <p>やさしい 24時間だけの小さなチャット</p>
        </div>
      </div>
      <div class="top-actions">
        <button class="pill" id="newRoomButton">新しいルーム</button>
        <button class="pill ghost small" id="messageBoardButton" type="button">意見交換掲示板</button>
        <button class="pill dev-switch" id="developerTabButton">こんにちは<br>開発者です</button>
      </div>
    </header>

    <main class="layout" id="mainLayout">
      <aside class="panel rooms" id="roomsPanel">
        <div class="panel-header">
          <h2>ルーム</h2>
          <span class="badge" id="roomCount">0</span>
        </div>
        <div class="room-list" id="roomList"></div>
        <div class="panel-footer">
          <div class="tip">
            <span class="tip-title">24時間ルール</span>
            <p>チャットとルームは24時間で消えます。やさしく話そう。</p>
          </div>
        </div>
      </aside>

      <div class="right-column">
        <section class="panel moby-consult js-chat-tab">
          <div class="panel-header">
            <div>
              <h2>モビーに相談</h2>
              <p class="subtitle">やさしいAIアシスタントがお答えします</p>
            </div>
            <div class="moby-avatar">🐾</div>
          </div>
          <div class="moby-chat" id="mobyChat">
            <div class="moby-welcome">
              <p>こんにちは！モビーだよ。<br>なんでも気軽に相談してね。</p>
            </div>
          </div>
          <div class="composer">
            <div class="composer-row">
              <input id="mobyInput" type="text" placeholder="モビーに聞いてみよう…" />
              <button class="pill send" id="mobyButton">聞く</button>
            </div>
          </div>
        </section>

        <section class="panel chat js-chat-tab">
        <div class="panel-header">
          <div>
            <h2 id="roomTitle">Loading...</h2>
            <p class="subtitle" id="roomSubtitle">ローカルサーバーへ接続中</p>
          </div>
          <div class="chat-header-actions">
            <span class="badge soft nickname-badge" id="nicknameDisplay">名前: -</span>
            <button class="pill ghost small" id="changeNicknameButton" type="button">名前変更</button>
          </div>
        </div>

        <div class="chat-body" id="chatBody"></div>

        <div class="composer">
          <div class="composer-row">
            <input id="composerInput" type="text" placeholder="やさしい言葉をひとこと…" />
            <button class="pill send" id="sendButton">送信</button>
          </div>
        </div>
        </section>

        <section class="panel developer-panel hidden-tab" id="developerPanel">
          <div class="panel-header">
            <div>
              <h2>開発者から</h2>
              <p class="subtitle">ご意見をお聞かせください</p>
            </div>
            <button class="pill ghost small" id="backToChatButton" type="button">チャットへ戻る</button>
          </div>
          <div class="developer-message" id="developerMessage">
            <p>こんにちは。モビー兼MofuChatの開発者です。このチャットはしんどい人同士助け合えるコミュニティが作れたらいいなと思って作成しました。アプリとしてほしい人がいたら下ご意見に入力していただければ幸いです。また、下のご意見には、他にはこんなアプリ・サービスがあったらいいな、といった意見も待ってます。皆さんが少しでも楽しい毎日を過ごせたらと思ってます。</p>
          </div>
          <form class="feedback-form" id="feedbackForm">
            <label class="feedback-label" for="feedbackOpinion">ご意見</label>
            <textarea id="feedbackOpinion" maxlength="1200" required placeholder="自由にご意見を書いてください"></textarea>
            <div class="feedback-optional">
              <div>
                <label class="feedback-label" for="feedbackNickname">ニックネーム（任意）</label>
                <input id="feedbackNickname" type="text" maxlength="24" placeholder="例: ねこ123" />
              </div>
              <div>
                <label class="feedback-label" for="feedbackEmail">メールアドレス（任意）</label>
                <input id="feedbackEmail" type="email" maxlength="120" placeholder="example@mail.com" />
              </div>
            </div>
            <div class="feedback-actions">
              <button class="pill send" id="feedbackSubmitButton" type="submit">ご意見を送信</button>
              <span class="feedback-status" id="feedbackStatus" aria-live="polite"></span>
            </div>
          </form>
        </section>
      </div>
    </main>
    <script>
      const state = { rooms: [], activeRoomId: null };
      const roomPasswords = new Map();
      const nicknameKey = "mofu_nickname";
      let nickname = normalizeNickname(localStorage.getItem(nicknameKey));

      const roomListEl = document.getElementById("roomList");
      const roomCountEl = document.getElementById("roomCount");
      const roomTitleEl = document.getElementById("roomTitle");
      const roomSubtitleEl = document.getElementById("roomSubtitle");
      const chatBodyEl = document.getElementById("chatBody");
      const composerInput = document.getElementById("composerInput");
      const sendButton = document.getElementById("sendButton");
      const changeNicknameButton = document.getElementById("changeNicknameButton");
      const nicknameDisplayEl = document.getElementById("nicknameDisplay");
      const newRoomButton = document.getElementById("newRoomButton");
      const messageBoardButton = document.getElementById("messageBoardButton");
      const developerTabButton = document.getElementById("developerTabButton");
      const backToChatButton = document.getElementById("backToChatButton");
      const mainLayoutEl = document.getElementById("mainLayout");
      const roomsPanelEl = document.getElementById("roomsPanel");
      const chatTabEls = Array.from(document.querySelectorAll(".js-chat-tab"));
      const developerPanelEl = document.getElementById("developerPanel");
      const developerMessageEl = document.getElementById("developerMessage");
      const feedbackFormEl = document.getElementById("feedbackForm");
      const feedbackOpinionEl = document.getElementById("feedbackOpinion");
      const feedbackNicknameEl = document.getElementById("feedbackNickname");
      const feedbackEmailEl = document.getElementById("feedbackEmail");
      const feedbackSubmitButtonEl = document.getElementById("feedbackSubmitButton");
      const feedbackStatusEl = document.getElementById("feedbackStatus");
      let activeTab = "chat";

      const fmtTime = (ms) => {
        const date = new Date(ms);
        const h = String(date.getHours()).padStart(2, "0");
        const m = String(date.getMinutes()).padStart(2, "0");
        return `${h}:${m}`;
      };

      const fmtRemaining = (ms) => {
        if (!ms) return "24時間で自動消去";
        const diff = Math.max(0, ms - Date.now());
        const hours = Math.floor(diff / 3600000);
        const mins = Math.floor((diff % 3600000) / 60000);
        return `自動消去まで ${hours}時間 ${mins}分`;
      };

      function buildRandomNickname() {
        return `ねこ${Math.floor(Math.random() * 900 + 100)}`;
      }

      function normalizeNickname(input) {
        const trimmed = String(input || "").trim();
        return trimmed ? trimmed.slice(0, 12) : "";
      }

      function updateNicknameDisplay() {
        if (!nicknameDisplayEl) return;
        nicknameDisplayEl.textContent = `名前: ${nickname || "-"}`;
      }

      function setNickname(nextNickname) {
        nickname = normalizeNickname(nextNickname) || buildRandomNickname();
        localStorage.setItem(nicknameKey, nickname);
        updateNicknameDisplay();
      }

      function ensureNickname() {
        if (nickname) {
          updateNicknameDisplay();
          return;
        }
        const input = window.prompt("ニックネームを登録してください");
        setNickname(normalizeNickname(input));
      }

      function promptNicknameChange() {
        const input = window.prompt("新しいニックネームを入力してください", nickname || "");
        if (input === null) return;
        setNickname(normalizeNickname(input));
        loadMessages();
      }

      function getPasswordForRoom(roomId) {
        return roomPasswords.get(roomId) || "";
      }

      function promptPassword(room) {
        const pw = window.prompt(`「${room.name}」のパスワードを入力`);
        if (!pw) return false;
        roomPasswords.set(room.id, pw);
        return true;
      }

      function setActiveTab(tabName) {
        activeTab = tabName;
        const isDeveloperTab = tabName === "developer";
        chatTabEls.forEach((el) => el.classList.toggle("hidden-tab", isDeveloperTab));
        roomsPanelEl.classList.toggle("hidden-tab", isDeveloperTab);
        mainLayoutEl.classList.toggle("developer-mode", isDeveloperTab);
        developerPanelEl.classList.toggle("hidden-tab", !isDeveloperTab);
        developerTabButton.classList.toggle("active", isDeveloperTab);
        if (isDeveloperTab) {
          developerMessageEl.classList.remove("show");
          window.requestAnimationFrame(() => {
            developerMessageEl.classList.add("show");
          });
        }
      }

      async function fetchRooms() {
        const res = await fetch("/api/rooms");
        const data = await res.json();
        state.rooms = data.rooms;
        roomCountEl.textContent = data.rooms.length;
        if (!state.activeRoomId && data.rooms.length) {
          state.activeRoomId = data.rooms[0].id;
        }
        if (state.activeRoomId && !data.rooms.find((room) => room.id === state.activeRoomId)) {
          state.activeRoomId = data.rooms[0]?.id || null;
        }
        renderRooms();
        await loadMessages();
      }

      function renderRooms() {
        roomListEl.innerHTML = "";
        state.rooms.forEach((room) => {
          const btn = document.createElement("button");
          btn.className = `room ${room.id === state.activeRoomId ? "active" : ""}`;
          const lockNote = room.hasPassword ? " ・鍵あり" : "";
          btn.innerHTML = `
            <span class="dot"></span>
            <div>
              <h3>${room.name}</h3>
              <p>アクティブ ${room.activeMessages} ・消えるまで ${room.nextExpiresIn}${lockNote}</p>
            </div>
          `;
          btn.addEventListener("click", async () => {
            setActiveTab("chat");
            if (room.hasPassword && !getPasswordForRoom(room.id)) {
              const ok = promptPassword(room);
              if (!ok) return;
            }
            state.activeRoomId = room.id;
            renderRooms();
            await loadMessages();
            // 選択した部屋までスクロール
            setTimeout(() => {
              const activeBtn = roomListEl.querySelector('.room.active');
              if (activeBtn) {
                activeBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
              }
            }, 100);
          });
          roomListEl.appendChild(btn);
        });
      }

      async function loadMessages() {
        if (!state.activeRoomId) return;
        const password = getPasswordForRoom(state.activeRoomId);
        const res = await fetch(`/api/rooms/${state.activeRoomId}/messages`, {
          headers: password ? { "x-room-password": password } : {},
        });
        if (res.status === 403) {
          const room = state.rooms.find((r) => r.id === state.activeRoomId);
          if (room?.hasPassword && promptPassword(room)) {
            return loadMessages();
          }
        }
        const data = await res.json();
        const activeRoom = state.rooms.find((r) => r.id === state.activeRoomId);
        roomTitleEl.textContent = activeRoom?.name || "Room";
        roomSubtitleEl.textContent = fmtRemaining(activeRoom?.nextExpireAt);
        chatBodyEl.innerHTML = "";
        data.messages.forEach((msg) => {
          const wrapper = document.createElement("div");
          const isMe = msg.author === nickname;
          wrapper.className = `message ${isMe ? "me" : "other"}`;
          wrapper.innerHTML = `
            ${isMe ? "" : `
              <div class="author-section">
                <span class="author-name">${msg.author}</span>
                <div class="avatar">?</div>
              </div>
            `}
            <div class="bubble">
              <p>${msg.body}</p>
              <span class="meta">${fmtTime(msg.createdAt)} ・消える時刻 ${fmtTime(msg.expiresAt)}</span>
            </div>
            ${isMe ? `
              <div class="author-section">
                <span class="author-name">${msg.author}</span>
                <div class="avatar">ME</div>
              </div>
            ` : ""}
          `;
          chatBodyEl.appendChild(wrapper);
        });
      }

      async function sendMessage() {
        const body = composerInput.value.trim();
        if (!body || !state.activeRoomId) return;
        const password = getPasswordForRoom(state.activeRoomId);
        await fetch(`/api/rooms/${state.activeRoomId}/messages`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...(password ? { "x-room-password": password } : {}),
          },
          body: JSON.stringify({ author: nickname, body }),
        });
        composerInput.value = "";
        await loadMessages();
      }

      sendButton.addEventListener("click", sendMessage);
      changeNicknameButton.addEventListener("click", promptNicknameChange);
      composerInput.addEventListener("keydown", (event) => {
        if (event.key === "Enter") sendMessage();
      });
      newRoomButton.addEventListener("click", async () => {
        setActiveTab("chat");
        const name = window.prompt("ルーム名は？");
        if (!name) return;
        const password = window.prompt("パスワード（任意・空欄OK）") || "";
        await fetch("/api/rooms", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, password }),
        });
        await fetchRooms();
        // 作成した部屋までスクロール
        setTimeout(() => {
          const activeBtn = roomListEl.querySelector('.room.active');
          if (activeBtn) {
            activeBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }
        }, 100);
      });
      messageBoardButton.addEventListener("click", () => {
        window.location.href = "/message/";
      });

      async function submitFeedback(event) {
        event.preventDefault();
        const opinion = feedbackOpinionEl.value.trim();
        const nicknameInput = feedbackNicknameEl.value.trim();
        const emailInput = feedbackEmailEl.value.trim();
        if (!opinion) return;

        feedbackSubmitButtonEl.disabled = true;
        feedbackStatusEl.textContent = "送信中です...";
        try {
          const res = await fetch("/api/feedback", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              opinion,
              nickname: nicknameInput,
              email: emailInput,
            }),
          });
          const data = await res.json().catch(() => null);
          if (!res.ok) {
            throw new Error(data?.error || "送信に失敗しました");
          }
          feedbackOpinionEl.value = "";
          feedbackStatusEl.textContent = "ご意見を受け付けました。ありがとうございます。";
        } catch (err) {
          feedbackStatusEl.textContent = `送信エラー: ${err.message}`;
        } finally {
          feedbackSubmitButtonEl.disabled = false;
        }
      }

      // モビーに相談機能 (Cloudflare Workers AI via Vercel API)
      const mobyChatEl = document.getElementById("mobyChat");
      const mobyInput = document.getElementById("mobyInput");
      const mobyButton = document.getElementById("mobyButton");
      const mobyHistory = [];

      function addMobyMessage(content, isUser) {
        const msg = document.createElement("div");
        msg.className = `moby-message ${isUser ? "user" : "moby"}`;
        msg.innerHTML = `
          <div class="moby-bubble">
            ${isUser ? "" : '<span class="moby-icon">🐾</span>'}
            <p>${content}</p>
          </div>
        `;
        mobyChatEl.appendChild(msg);
        mobyChatEl.scrollTop = mobyChatEl.scrollHeight;
      }

      // Moby API 呼び出し（Vercelプロキシ経由）
      async function callMobyAPI(messages) {
        console.log("Calling Moby API with messages:", messages);
        
        const res = await fetch("/api/moby", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ messages }),
        });

        console.log("Moby API response status:", res.status);

        const data = await res.json().catch((e) => {
          console.error("Failed to parse response JSON:", e);
          return null;
        });

        console.log("Moby API response data:", data);

        if (!res.ok) {
          console.error("Moby API Error:", res.status, data);
          throw new Error(`Moby API Error: ${res.status}`);
        }

        return data?.response || null;
      }

      async function askMoby() {
        const question = mobyInput.value.trim();
        if (!question) return;

        mobyInput.value = "";
        addMobyMessage(question, true);
        mobyHistory.push({ role: "user", content: question });

        // ローディング表示
        const loadingEl = document.createElement("div");
        loadingEl.className = "moby-message moby";
        loadingEl.innerHTML = `<div class="moby-bubble"><span class="moby-icon">🐾</span><p class="moby-loading">考え中...</p></div>`;
        mobyChatEl.appendChild(loadingEl);
        mobyChatEl.scrollTop = mobyChatEl.scrollHeight;

        let answer = null;

        try {
          answer = await callMobyAPI(mobyHistory);
        } catch (err) {
          console.error("Moby API failed:", err);
        }

        loadingEl.remove();

        if (answer) {
          mobyHistory.push({ role: "assistant", content: answer });
          addMobyMessage(answer, false);
        } else {
          addMobyMessage("ごめんね、接続エラーが起きちゃった。もう一度試してみてね。", false);
        }
      }

      mobyButton.addEventListener("click", askMoby);
      mobyInput.addEventListener("keydown", (event) => {
        if (event.key === "Enter") askMoby();
      });
      developerTabButton.addEventListener("click", () => {
        setActiveTab(activeTab === "developer" ? "chat" : "developer");
      });
      backToChatButton.addEventListener("click", () => {
        setActiveTab("chat");
      });
      feedbackFormEl.addEventListener("submit", submitFeedback);

      ensureNickname();
      fetchRooms();
      setInterval(fetchRooms, 15000);
    </script>
  </body>
</html>
