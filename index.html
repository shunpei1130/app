<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MofuChat - 24æ™‚é–“ã§æ¶ˆãˆã‚‹ã‹ã‚ã„ã„ãƒãƒ£ãƒƒãƒˆ</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800;900&family=Yomogi&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="bg-sparkle"></div>
    <header class="topbar">
      <div class="logo">
        <span class="logo-badge">MC</span>
        <div class="logo-text">
          <h1>MofuChat</h1>
          <p>ã‚„ã•ã—ã„ 24æ™‚é–“ã ã‘ã®å°ã•ãªãƒãƒ£ãƒƒãƒˆ</p>
        </div>
      </div>
      <div class="top-actions">
        <button class="pill" id="newRoomButton">æ–°ã—ã„ãƒ«ãƒ¼ãƒ </button>
      </div>
    </header>

    <main class="layout">
      <aside class="panel rooms">
        <div class="panel-header">
          <h2>ãƒ«ãƒ¼ãƒ </h2>
          <span class="badge" id="roomCount">0</span>
        </div>
        <div class="room-list" id="roomList"></div>
        <div class="panel-footer">
          <div class="tip">
            <span class="tip-title">24æ™‚é–“ãƒ«ãƒ¼ãƒ«</span>
            <p>ãƒãƒ£ãƒƒãƒˆã¯24æ™‚é–“ã§æ¶ˆãˆã¾ã™ã€‚ã‚„ã•ã—ãè©±ãã†ã€‚</p>
          </div>
        </div>
      </aside>

      <div class="right-column">
        <section class="panel moby-consult">
          <div class="panel-header">
            <div>
              <h2>ãƒ¢ãƒ“ãƒ¼ã«ç›¸è«‡</h2>
              <p class="subtitle">ã‚„ã•ã—ã„AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãŒãŠç­”ãˆã—ã¾ã™</p>
            </div>
            <div class="moby-avatar">ğŸ¾</div>
          </div>
          <div class="moby-chat" id="mobyChat">
            <div class="moby-welcome">
              <p>ã“ã‚“ã«ã¡ã¯ï¼ãƒ¢ãƒ“ãƒ¼ã ã‚ˆã€‚<br>ãªã‚“ã§ã‚‚æ°—è»½ã«ç›¸è«‡ã—ã¦ã­ã€‚</p>
            </div>
          </div>
          <div class="composer">
            <div class="composer-row">
              <input id="mobyInput" type="text" placeholder="ãƒ¢ãƒ“ãƒ¼ã«èã„ã¦ã¿ã‚ˆã†â€¦" />
              <button class="pill send" id="mobyButton">èã</button>
            </div>
          </div>
        </section>

        <section class="panel chat">
        <div class="panel-header">
          <div>
            <h2 id="roomTitle">Loading...</h2>
            <p class="subtitle" id="roomSubtitle">ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼ã¸æ¥ç¶šä¸­</p>
          </div>
        </div>

        <div class="chat-body" id="chatBody"></div>

        <div class="composer">
          <div class="composer-row">
            <input id="composerInput" type="text" placeholder="ã‚„ã•ã—ã„è¨€è‘‰ã‚’ã²ã¨ã“ã¨â€¦" />
            <button class="pill send" id="sendButton">é€ä¿¡</button>
          </div>
        </div>
        </section>
      </div>
    </main>
    <script>
      const state = { rooms: [], activeRoomId: null };
      const roomPasswords = new Map();
      const nicknameKey = "mofu_nickname";
      let nickname = localStorage.getItem(nicknameKey);

      const roomListEl = document.getElementById("roomList");
      const roomCountEl = document.getElementById("roomCount");
      const roomTitleEl = document.getElementById("roomTitle");
      const roomSubtitleEl = document.getElementById("roomSubtitle");
      const chatBodyEl = document.getElementById("chatBody");
      const composerInput = document.getElementById("composerInput");
      const sendButton = document.getElementById("sendButton");
      const newRoomButton = document.getElementById("newRoomButton");

      const fmtTime = (ms) => {
        const date = new Date(ms);
        const h = String(date.getHours()).padStart(2, "0");
        const m = String(date.getMinutes()).padStart(2, "0");
        return `${h}:${m}`;
      };

      const fmtRemaining = (ms) => {
        if (!ms) return "24æ™‚é–“ã§è‡ªå‹•æ¶ˆå»";
        const diff = Math.max(0, ms - Date.now());
        const hours = Math.floor(diff / 3600000);
        const mins = Math.floor((diff % 3600000) / 60000);
        return `è‡ªå‹•æ¶ˆå»ã¾ã§ ${hours}æ™‚é–“ ${mins}åˆ†`;
      };

      function ensureNickname() {
        if (nickname) return;
        const input = window.prompt("ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„");
        nickname = String(input || "").trim().slice(0, 12);
        if (!nickname) {
          nickname = `ã­ã“${Math.floor(Math.random() * 900 + 100)}`;
        }
        localStorage.setItem(nicknameKey, nickname);
      }

      function getPasswordForRoom(roomId) {
        return roomPasswords.get(roomId) || "";
      }

      function promptPassword(room) {
        const pw = window.prompt(`ã€Œ${room.name}ã€ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›`);
        if (!pw) return false;
        roomPasswords.set(room.id, pw);
        return true;
      }

      async function fetchRooms() {
        const res = await fetch("/api/rooms");
        const data = await res.json();
        state.rooms = data.rooms;
        roomCountEl.textContent = data.rooms.length;
        if (!state.activeRoomId && data.rooms.length) {
          state.activeRoomId = data.rooms[0].id;
        }
        if (state.activeRoomId && !data.rooms.find((room) => room.id === state.activeRoomId)) {
          state.activeRoomId = data.rooms[0]?.id || null;
        }
        renderRooms();
        await loadMessages();
      }

      function renderRooms() {
        roomListEl.innerHTML = "";
        state.rooms.forEach((room) => {
          const btn = document.createElement("button");
          btn.className = `room ${room.id === state.activeRoomId ? "active" : ""}`;
          const lockNote = room.hasPassword ? " ãƒ»éµã‚ã‚Š" : "";
          btn.innerHTML = `
            <span class="dot"></span>
            <div>
              <h3>${room.name}</h3>
              <p>ã‚¢ã‚¯ãƒ†ã‚£ãƒ– ${room.activeMessages} ãƒ»æ¶ˆãˆã‚‹ã¾ã§ ${room.nextExpiresIn}${lockNote}</p>
            </div>
          `;
          btn.addEventListener("click", async () => {
            if (room.hasPassword && !getPasswordForRoom(room.id)) {
              const ok = promptPassword(room);
              if (!ok) return;
            }
            state.activeRoomId = room.id;
            renderRooms();
            await loadMessages();
            // é¸æŠã—ãŸéƒ¨å±‹ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            setTimeout(() => {
              const activeBtn = roomListEl.querySelector('.room.active');
              if (activeBtn) {
                activeBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
              }
            }, 100);
          });
          roomListEl.appendChild(btn);
        });
      }

      async function loadMessages() {
        if (!state.activeRoomId) return;
        const password = getPasswordForRoom(state.activeRoomId);
        const res = await fetch(`/api/rooms/${state.activeRoomId}/messages`, {
          headers: password ? { "x-room-password": password } : {},
        });
        if (res.status === 403) {
          const room = state.rooms.find((r) => r.id === state.activeRoomId);
          if (room?.hasPassword && promptPassword(room)) {
            return loadMessages();
          }
        }
        const data = await res.json();
        const activeRoom = state.rooms.find((r) => r.id === state.activeRoomId);
        roomTitleEl.textContent = activeRoom?.name || "Room";
        roomSubtitleEl.textContent = fmtRemaining(activeRoom?.nextExpireAt);
        chatBodyEl.innerHTML = "";
        data.messages.forEach((msg) => {
          const wrapper = document.createElement("div");
          const isMe = msg.author === nickname;
          wrapper.className = `message ${isMe ? "me" : "other"}`;
          wrapper.innerHTML = `
            ${isMe ? "" : `
              <div class="author-section">
                <span class="author-name">${msg.author}</span>
                <div class="avatar">?</div>
              </div>
            `}
            <div class="bubble">
              <p>${msg.body}</p>
              <span class="meta">${fmtTime(msg.createdAt)} ãƒ»æ¶ˆãˆã‚‹æ™‚åˆ» ${fmtTime(msg.expiresAt)}</span>
            </div>
            ${isMe ? `
              <div class="author-section">
                <span class="author-name">${msg.author}</span>
                <div class="avatar">ME</div>
              </div>
            ` : ""}
          `;
          chatBodyEl.appendChild(wrapper);
        });
      }

      async function sendMessage() {
        const body = composerInput.value.trim();
        if (!body || !state.activeRoomId) return;
        const password = getPasswordForRoom(state.activeRoomId);
        await fetch(`/api/rooms/${state.activeRoomId}/messages`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...(password ? { "x-room-password": password } : {}),
          },
          body: JSON.stringify({ author: nickname, body }),
        });
        composerInput.value = "";
        await loadMessages();
      }

      sendButton.addEventListener("click", sendMessage);
      composerInput.addEventListener("keydown", (event) => {
        if (event.key === "Enter") sendMessage();
      });
      newRoomButton.addEventListener("click", async () => {
        const name = window.prompt("ãƒ«ãƒ¼ãƒ åã¯ï¼Ÿ");
        if (!name) return;
        const password = window.prompt("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆä»»æ„ãƒ»ç©ºæ¬„OKï¼‰") || "";
        await fetch("/api/rooms", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, password }),
        });
        await fetchRooms();
        // ä½œæˆã—ãŸéƒ¨å±‹ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        setTimeout(() => {
          const activeBtn = roomListEl.querySelector('.room.active');
          if (activeBtn) {
            activeBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }
        }, 100);
      });

      // ãƒ¢ãƒ“ãƒ¼ã«ç›¸è«‡æ©Ÿèƒ½ (Cloudflare Workers AI via Vercel API)
      const mobyChatEl = document.getElementById("mobyChat");
      const mobyInput = document.getElementById("mobyInput");
      const mobyButton = document.getElementById("mobyButton");
      const mobyHistory = [];

      function addMobyMessage(content, isUser) {
        const msg = document.createElement("div");
        msg.className = `moby-message ${isUser ? "user" : "moby"}`;
        msg.innerHTML = `
          <div class="moby-bubble">
            ${isUser ? "" : '<span class="moby-icon">ğŸ¾</span>'}
            <p>${content}</p>
          </div>
        `;
        mobyChatEl.appendChild(msg);
        mobyChatEl.scrollTop = mobyChatEl.scrollHeight;
      }

      // Moby API å‘¼ã³å‡ºã—ï¼ˆVercelãƒ—ãƒ­ã‚­ã‚·çµŒç”±ï¼‰
      async function callMobyAPI(messages) {
        console.log("Calling Moby API with messages:", messages);
        
        const res = await fetch("/api/moby", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ messages }),
        });

        console.log("Moby API response status:", res.status);

        const data = await res.json().catch((e) => {
          console.error("Failed to parse response JSON:", e);
          return null;
        });

        console.log("Moby API response data:", data);

        if (!res.ok) {
          console.error("Moby API Error:", res.status, data);
          throw new Error(`Moby API Error: ${res.status}`);
        }

        return data?.response || null;
      }

      async function askMoby() {
        const question = mobyInput.value.trim();
        if (!question) return;

        mobyInput.value = "";
        addMobyMessage(question, true);
        mobyHistory.push({ role: "user", content: question });

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
        const loadingEl = document.createElement("div");
        loadingEl.className = "moby-message moby";
        loadingEl.innerHTML = `<div class="moby-bubble"><span class="moby-icon">ğŸ¾</span><p class="moby-loading">è€ƒãˆä¸­...</p></div>`;
        mobyChatEl.appendChild(loadingEl);
        mobyChatEl.scrollTop = mobyChatEl.scrollHeight;

        let answer = null;

        try {
          answer = await callMobyAPI(mobyHistory);
        } catch (err) {
          console.error("Moby API failed:", err);
        }

        loadingEl.remove();

        if (answer) {
          mobyHistory.push({ role: "assistant", content: answer });
          addMobyMessage(answer, false);
        } else {
          addMobyMessage("ã”ã‚ã‚“ã­ã€æ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒèµ·ãã¡ã‚ƒã£ãŸã€‚ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ã¿ã¦ã­ã€‚", false);
        }
      }

      mobyButton.addEventListener("click", askMoby);
      mobyInput.addEventListener("keydown", (event) => {
        if (event.key === "Enter") askMoby();
      });

      ensureNickname();
      fetchRooms();
      setInterval(fetchRooms, 15000);
    </script>
  </body>
</html>
